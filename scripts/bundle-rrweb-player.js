#!/usr/bin/env node
/* eslint-disable no-undef */

'use strict';

import { build } from 'esbuild';
import fs from 'fs/promises';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';

const __dirname = dirname(fileURLToPath(import.meta.url));
const rootDir = join(__dirname, '..');

const outfile = join(rootDir, 'build/rrweb-player-bundle.js');
const generatedDir = join(rootDir, 'src/generated');
const generatedFile = join(generatedDir, 'rrweb-player.ts');

(async () => {
  // Ensure build directory exists
  await fs.mkdir(join(rootDir, 'build'), { recursive: true });

  // Bundle @posthog/rrweb-player as IIFE for browser
  await build({
    entryPoints: [join(rootDir, 'node_modules/@posthog/rrweb-player/dist/rrweb-player.js')],
    bundle: true,
    format: 'iife',
    globalName: 'rrwebPlayer',
    outfile,
    minify: true,
    platform: 'browser',
    target: ['chrome90', 'firefox88', 'safari14'],
  });

  const playerJS = await fs.readFile(outfile, 'utf-8');

  // Read the CSS file
  const cssPath = join(rootDir, 'node_modules/@posthog/rrweb-player/dist/style.css');
  const playerCSS = await fs.readFile(cssPath, 'utf-8');

  // Generate TypeScript file with the bundled code
  const tsContent = `// Auto-generated by scripts/bundle-rrweb-player.js - DO NOT EDIT
// Bundled from @posthog/rrweb-player for player HTML page

export const RRWEB_PLAYER_CSS = ${JSON.stringify(playerCSS)};

export const RRWEB_PLAYER_JS = ${JSON.stringify(playerJS)};
`;

  await fs.mkdir(generatedDir, { recursive: true });
  await fs.writeFile(generatedFile, tsContent);
  console.log('Generated src/generated/rrweb-player.ts');
})();
