#!/usr/bin/env node
/* eslint-disable no-undef */

'use strict';

import { build } from 'vite';
import fs from 'fs/promises';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';

const __dirname = dirname(fileURLToPath(import.meta.url));
const rootDir = join(__dirname, '..');

const generatedDir = join(rootDir, 'src/generated');
const buildDir = join(generatedDir, 'player-build');
const generatedFile = join(generatedDir, 'rrweb-player.ts');

(async () => {
  console.log('Building Svelte player...');

  // Build with Vite
  await build({
    configFile: join(rootDir, 'vite.config.ts'),
    logLevel: 'info',
  });

  // Read built files
  const playerJS = await fs.readFile(join(buildDir, 'recording-player.js'), 'utf-8');

  // Try to read CSS (may not exist if no styles)
  let playerCSS = '';
  try {
    playerCSS = await fs.readFile(join(buildDir, 'style.css'), 'utf-8');
  } catch {
    console.log('No separate CSS file generated (styles may be inlined)');
  }

  // Generate TypeScript file with the bundled code
  const tsContent = `// Auto-generated by scripts/bundle-svelte-player.js - DO NOT EDIT
// Bundled Svelte player for session replay

export const RRWEB_PLAYER_CSS = ${JSON.stringify(playerCSS)};

export const RRWEB_PLAYER_JS = ${JSON.stringify(playerJS)};
`;

  await fs.mkdir(generatedDir, { recursive: true });
  await fs.writeFile(generatedFile, tsContent);
  console.log('Generated src/generated/rrweb-player.ts');

  // Clean up build directory (keep only the TS file)
  // await fs.rm(buildDir, { recursive: true, force: true });
  // console.log('Cleaned up build directory');
})();
