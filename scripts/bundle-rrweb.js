#!/usr/bin/env node
/* eslint-disable no-undef */

'use strict';

import { build } from 'esbuild';
import fs from 'fs/promises';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';

const __dirname = dirname(fileURLToPath(import.meta.url));
const rootDir = join(__dirname, '..');

const rrwebOutfile = join(rootDir, 'build/rrweb-bundle.js');
const consoleOutfile = join(rootDir, 'build/rrweb-console-plugin-bundle.js');
const generatedDir = join(rootDir, 'src/generated');
const generatedFile = join(generatedDir, 'rrweb-script.ts');

(async () => {
  // Ensure build directory exists
  await fs.mkdir(join(rootDir, 'build'), { recursive: true });

  // Bundle @divmode/rrweb as IIFE for browser injection
  await build({
    entryPoints: [join(rootDir, 'node_modules/@divmode/rrweb/dist/rrweb.js')],
    bundle: true,
    format: 'iife',
    globalName: 'rrweb',
    outfile: rrwebOutfile,
    minify: true,
    platform: 'browser',
    target: ['chrome90', 'firefox88', 'safari14'],
  });

  // Bundle @divmode/rrweb-plugin-console-record as IIFE
  await build({
    entryPoints: [join(rootDir, 'node_modules/@divmode/rrweb-plugin-console-record/dist/rrweb-plugin-console-record.js')],
    bundle: true,
    format: 'iife',
    globalName: 'rrwebConsolePlugin',
    outfile: consoleOutfile,
    minify: true,
    platform: 'browser',
    target: ['chrome90', 'firefox88', 'safari14'],
  });

  const rrwebScript = await fs.readFile(rrwebOutfile, 'utf-8');
  const consoleScript = await fs.readFile(consoleOutfile, 'utf-8');

  // Generate TypeScript file with the bundled code
  const tsContent = `// Auto-generated by scripts/bundle-rrweb.js - DO NOT EDIT
// Bundled from @divmode/rrweb for browser injection (includes closed shadow DOM support)
export const RRWEB_RECORD_SCRIPT = ${JSON.stringify(rrwebScript)};

// Bundled from @divmode/rrweb-plugin-console-record for browser injection
export const RRWEB_CONSOLE_PLUGIN_SCRIPT = ${JSON.stringify(consoleScript)};
`;

  await fs.mkdir(generatedDir, { recursive: true });
  await fs.writeFile(generatedFile, tsContent);
  console.log('Generated src/generated/rrweb-script.ts');
})();
