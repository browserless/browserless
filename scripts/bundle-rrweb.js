#!/usr/bin/env node
/* eslint-disable no-undef */

'use strict';

import { build } from 'esbuild';
import fs from 'fs/promises';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';

const __dirname = dirname(fileURLToPath(import.meta.url));
const rootDir = join(__dirname, '..');

const outfile = join(rootDir, 'build/rrweb-bundle.js');
const generatedDir = join(rootDir, 'src/generated');
const generatedFile = join(generatedDir, 'rrweb-script.ts');

(async () => {
  // Ensure build directory exists
  await fs.mkdir(join(rootDir, 'build'), { recursive: true });

  // Bundle @rrweb/record as IIFE for browser injection
  await build({
    entryPoints: [join(rootDir, 'node_modules/@rrweb/record/dist/record.js')],
    bundle: true,
    format: 'iife',
    globalName: 'rrweb',
    outfile,
    minify: true,
    platform: 'browser',
    target: ['chrome90', 'firefox88', 'safari14'],
  });

  const script = await fs.readFile(outfile, 'utf-8');

  // Generate TypeScript file with the bundled code
  const tsContent = `// Auto-generated by scripts/bundle-rrweb.js - DO NOT EDIT
// Bundled from @rrweb/record for browser injection
export const RRWEB_RECORD_SCRIPT = ${JSON.stringify(script)};
`;

  await fs.mkdir(generatedDir, { recursive: true });
  await fs.writeFile(generatedFile, tsContent);
  console.log('Generated src/generated/rrweb-script.ts');
})();
